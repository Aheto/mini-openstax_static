<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Mini OpenStax: Interactive clinical learning module"/>
<title>Mini OpenStax ‚Äî Back Pain Triage and Management</title>
<link rel="stylesheet" href="../css/main.css">
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <h1 id="chapter-title">Loading Chapter...</h1>
      <div class="lo-tags" id="lo-tags"></div>
    </div>
    <div class="role-badge">Student View</div>
  </div>
  <main id="main-content">
    <div class="loading">Loading chapter content...</div>
  </main>
</div>

<script>
(function(){
'use strict';

const main = document.getElementById('main-content');
const titleEl = document.getElementById('chapter-title');
const loTagsEl = document.getElementById('lo-tags');

//======================
// üîß CONFIGURATION ‚Äî EDIT THESE FOR EACH CHAPTER
//======================
const CHAPTER_CONFIG = {
  title: "Back Pain Triage and Management",
  loTags: ["MOH-BP-1", "EMERGENCY-TRIAGE", "PRIMARY-CARE-MSK"],
  content: `
    <h2>Key Concepts: Back Pain Triage</h2>
    <p>Back pain is common but requires urgent attention if red flags are present. This module outlines when to refer urgently, how to manage acute causes, and how to approach non-urgent mechanical or inflammatory back pain.</p>

    <h3>üö® Urgent Red Flags (Refer Immediately)</h3>
    <ul>
      <li>Bladder or bowel disturbance (retention or incontinence)</li>
      <li>Numbness of buttocks, perineum, or legs</li>
      <li>Leg weakness or difficulty walking</li>
      <li>Recent injury with unavailable/abnormal x-ray</li>
      <li>Sudden severe upper abdominal pain with nausea/vomiting ‚Üí pancreatitis</li>
      <li>Pulsatile abdominal mass ‚Üí abdominal aortic aneurysm (AAA)</li>
      <li>Known cancer history</li>
      <li>Flank pain with dipstick findings:
        <ul>
          <li>Leucocytes/nitrites + fever + vomiting/BP&lt;90/pulse‚â•100/diabetes/male/pregnant/post-menopause ‚Üí complicated pyelonephritis</li>
          <li>Blood + sudden one-sided pain radiating to groin ‚Üí kidney stone</li>
        </ul>
      </li>
    </ul>

    <h3>ü©∫ Urgent Management (Before Referral)</h3>
    <ul>
      <li><strong>AAA suspected</strong>: Avoid IV fluids‚Äîeven if BP&lt;90 (‚ÜëBP may worsen rupture)</li>
      <li><strong>Pancreatitis or BP&lt;90</strong>: NaCl 0.9% 500mL IV over 30 min; repeat until systolic BP&gt;90; then 1L 6-hourly</li>
      <li><strong>Complicated pyelonephritis</strong>: Collect urine for MCS ‚Üí give ceftriaxone 1g IV/IM</li>
      <li><strong>Kidney stone</strong>: NaCl 0.9% 1L IV 6-hourly; morphine 10mg IM or 3‚Äì10mg slow IV for severe pain</li>
      <li><strong>Known cancer</strong>: Refer same day</li>
    </ul>

    <h3>ü©º Non-Urgent Back Pain Algorithm</h3>
    <p><strong>Step 1:</strong> Flank pain + leucocytes/nitrites ‚Üí uncomplicated pyelonephritis ‚Üí ciprofloxacin 500mg 12-hourly √ó7d + paracetamol</p>
    <p><strong>Step 2:</strong> Any of cough, weight loss, night sweats, or fever?</p>
    <ul>
      <li><strong>Yes</strong> ‚Üí Check age, duration, risk factors ‚Üí x-ray + ESR ‚Üí refer</li>
      <li><strong>No</strong> ‚Üí Check for inflammatory features</li>
    </ul>
    <p><strong>Inflammatory back pain likely if:</strong> Age &lt;40, pain disturbs sleep, improves with exercise, not relieved by rest</p>
    <p><strong>Mechanical back pain likely otherwise</strong></p>

    <h3>üíä Mechanical Back Pain Management</h3>
    <ul>
      <li>Reassure: pain is common, usually self-limiting, not always due to serious disease</li>
      <li>Advise activity, not bed rest</li>
      <li>Paracetamol 1g 4‚Äì6 hourly (max 4g/24h) √ó5d</li>
      <li>If no response after 1 week ‚Üí add ibuprofen 400mg 8-hourly with food √ó5d (avoid in ulcers, asthma, HTN, HF, CKD)</li>
      <li>If still no response ‚Üí add tramadol 50mg 6-hourly √ó5d</li>
      <li>Pain &gt;2 weeks or impacting function ‚Üí physiotherapy referral</li>
      <li>Pain ‚â•4 weeks ‚Üí assess mood, CVD risk, refer to doctor</li>
    </ul>

    <h3>ü©ª Inflammatory Back Pain Workup</h3>
    <ul>
      <li>ESR, HIV test, back x-ray</li>
      <li>Exclude TB</li>
      <li>Ibuprofen 400mg 8-hourly √ó5d</li>
      <li>Discuss with specialist</li>
    </ul>
  `,
  whatsappNumber: "233257320201",
  assessmentItems: [
    {
      id: "1",
      prompt: "Which of the following is an IMMEDIATE red flag requiring urgent referral in a patient with back pain?",
      options: [
        { id: "a", text: "Pain worse at night", is_correct: false },
        { id: "b", text: "Pain improved with walking", is_correct: false },
        { id: "c", text: "New onset leg weakness", is_correct: true },
        { id: "d", text: "Mild abdominal discomfort", is_correct: false }
      ]
    },
    {
      id: "2",
      prompt: "A 60-year-old with back pain and a pulsatile abdominal mass should NOT receive:",
      options: [
        { id: "a", text: "Morphine for pain", is_correct: false },
        { id: "b", text: "IV fluids", is_correct: true },
        { id: "c", text: "Oxygen", is_correct: false },
        { id: "d", text: "Urgent referral", is_correct: false }
      ]
    },
    {
      id: "3",
      prompt: "For suspected complicated pyelonephritis with back/flank pain, the FIRST step is:",
      options: [
        { id: "a", text: "Start ciprofloxacin", is_correct: false },
        { id: "b", text: "Give IV morphine", is_correct: false },
        { id: "c", text: "Collect urine for MCS", is_correct: true },
        { id: "d", text: "Order renal ultrasound", is_correct: false }
      ]
    },
    {
      id: "4",
      prompt: "Which feature suggests INFLAMMATORY rather than mechanical back pain?",
      options: [
        { id: "a", text: "Pain relieved by rest", is_correct: false },
        { id: "b", text: "Age over 50", is_correct: false },
        { id: "c", text: "Pain improves with exercise", is_correct: true },
        { id: "d", text: "History of heavy lifting", is_correct: false }
      ]
    },
    {
      id: "5",
      prompt: "Initial analgesia for mechanical back pain should be:",
      options: [
        { id: "a", text: "Ibuprofen 400mg 8-hourly", is_correct: false },
        { id: "b", text: "Tramadol 50mg 6-hourly", is_correct: false },
        { id: "c", text: "Paracetamol 1g 4‚Äì6 hourly", is_correct: true },
        { id: "d", text: "Morphine 10mg IM", is_correct: false }
      ]
    },
    {
      id: "6",
      prompt: "A patient with known cancer and new back pain should:",
      options: [
        { id: "a", text: "Be managed with paracetamol and rest", is_correct: false },
        { id: "b", text: "Be referred the same day", is_correct: true },
        { id: "c", text: "Have an ESR checked in 1 week", is_correct: false },
        { id: "d", text: "Start ibuprofen immediately", is_correct: false }
      ]
    },
    {
      id: "7",
      prompt: "Which finding on urine dipstick in a febrile patient with flank pain suggests kidney stone?",
      options: [
        { id: "a", text: "Leucocytes and nitrites", is_correct: false },
        { id: "b", text: "Protein", is_correct: false },
        { id: "c", text: "Blood", is_correct: true },
        { id: "d", text: "Glucose", is_correct: false }
      ]
    },
    {
      id: "8",
      prompt: "IV fluid management for suspected pancreatitis with BP < 90/60 includes:",
      options: [
        { id: "a", text: "NaCl 0.9% 500mL over 30 min, repeat until SBP > 90", is_correct: true },
        { id: "b", text: "Ringer‚Äôs lactate 2L bolus", is_correct: false },
        { id: "c", text: "No IV fluids due to rupture risk", is_correct: false },
        { id: "d", text: "Dextrose 5% at 125mL/h", is_correct: false }
      ]
    },
    {
      id: "9",
      prompt: "Ibuprofen should be AVOIDED in back pain management if the patient has:",
      options: [
        { id: "a", text: "Hypertension", is_correct: true },
        { id: "b", text: "Depression", is_correct: false },
        { id: "c", text: "Obesity", is_correct: false },
        { id: "d", text: "Mild headache", is_correct: false }
      ]
    },
    {
      id: "10",
      prompt: "When should a patient with mechanical back pain be referred for physiotherapy?",
      options: [
        { id: "a", text: "Immediately at first visit", is_correct: false },
        { id: "b", text: "If pain > 2 weeks or affecting daily function", is_correct: true },
        { id: "c", text: "Only if over age 65", is_correct: false },
        { id: "d", text: "After 1 day of paracetamol", is_correct: false }
      ]
    },
    {
      id: "11",
      prompt: "Which symptom combination suggests complicated pyelonephritis?",
      options: [
        { id: "a", text: "Flank pain + blood on dipstick + groin radiation", is_correct: false },
        { id: "b", text: "Flank pain + leucocytes + fever + BP < 90", is_correct: true },
        { id: "c", text: "Back pain + morning stiffness >30 min", is_correct: false },
        { id: "d", text: "Low back pain after gardening", is_correct: false }
      ]
    },
    {
      id: "12",
      prompt: "For inflammatory back pain, which test is recommended?",
      options: [
        { id: "a", text: "HbA1c", is_correct: false },
        { id: "b", text: "ESR", is_correct: true },
        { id: "c", text: "Liver function tests", is_correct: false },
        { id: "d", text: "Thyroid panel", is_correct: false }
      ]
    },
    {
      id: "13",
      prompt: "A 35-year-old with back pain that wakes them at night and improves with morning exercise likely has:",
      options: [
        { id: "a", text: "Mechanical back pain", is_correct: false },
        { id: "b", text: "Inflammatory back pain", is_correct: true },
        { id: "c", text: "Kidney stone", is_correct: false },
        { id: "d", text: "Muscle strain", is_correct: false }
      ]
    },
    {
      id: "14",
      prompt: "First-line antibiotic for UNCOMPLICATED pyelonephritis in back pain with flank symptoms is:",
      options: [
        { id: "a", text: "Ceftriaxone", is_correct: false },
        { id: "b", text: "Amoxicillin", is_correct: false },
        { id: "c", text: "Ciprofloxacin", is_correct: true },
        { id: "d", text: "Metronidazole", is_correct: false }
      ]
    },
    {
      id: "15",
      prompt: "Morphine for kidney stone pain should be given:",
      options: [
        { id: "a", text: "Only orally", is_correct: false },
        { id: "b", text: "IV undiluted for rapid effect", is_correct: false },
        { id: "c", text: "IM or slow IV (3‚Äì10mg)", is_correct: true },
        { id: "d", text: "With NSAIDs only", is_correct: false }
      ]
    },
    {
      id: "16",
      prompt: "When should TB be excluded in back pain evaluation?",
      options: [
        { id: "a", text: "In all cases", is_correct: false },
        { id: "b", text: "Only if HIV positive", is_correct: false },
        { id: "c", text: "When inflammatory back pain is suspected", is_correct: true },
        { id: "d", text: "Only in children", is_correct: false }
      ]
    },
    {
      id: "17",
      prompt: "Tramadol is added in mechanical back pain when:",
      options: [
        { id: "a", text: "Pain starts", is_correct: false },
        { id: "b", text: "Paracetamol and ibuprofen fail after 1‚Äì2 weeks", is_correct: true },
        { id: "c", text: "Patient requests opioids", is_correct: false },
        { id: "d", text: "Age > 70", is_correct: false }
      ]
    },
    {
      id: "18",
      prompt: "Which patient needs an urgent x-ray?",
      options: [
        { id: "a", text: "25-year-old with post-exercise backache", is_correct: false },
        { id: "b", text: "45-year-old with 8-week progressive pain and weight loss", is_correct: true },
        { id: "c", text: "30-year-old with mild stiffness", is_correct: false },
        { id: "d", text: "50-year-old with resolved pain", is_correct: false }
      ]
    },
    {
      id: "19",
      prompt: "Reassurance in mechanical back pain should include all EXCEPT:",
      options: [
        { id: "a", text: "Pain usually resolves on its own", is_correct: false },
        { id: "b", text: "Bed rest is essential for healing", is_correct: true },
        { id: "c", text: "Tests often don‚Äôt show a cause", is_correct: false },
        { id: "d", text: "Pain ‚â† cancer", is_correct: false }
      ]
    },
    {
      id: "20",
      prompt: "Which condition requires AVOIDING IV fluids even if hypotensive?",
      options: [
        { id: "a", text: "Pancreatitis", is_correct: false },
        { id: "b", text: "Pyelonephritis", is_correct: false },
        { id: "c", text: "Abdominal aortic aneurysm", is_correct: true },
        { id: "d", text: "Kidney stone", is_correct: false }
      ]
    }
  ]
};

//======================
// RENDER CHAPTER CONTENT
//======================
function renderChapter(){
  titleEl.textContent = CHAPTER_CONFIG.title;
  loTagsEl.innerHTML = '';
  CHAPTER_CONFIG.loTags.forEach(tag => {
    const span = document.createElement('span');
    span.className = 'lo-tag';
    span.textContent = tag;
    loTagsEl.appendChild(span);
  });

  const contentDiv = document.createElement('div');
  contentDiv.className = 'chapter-content';
  contentDiv.innerHTML = CHAPTER_CONFIG.content;

  let quizHTML = '';
  const items = CHAPTER_CONFIG.assessmentItems;
  if(items.length > 0){
    quizHTML = `
      <section class="card quiz-section">
        <h2>Check Your Understanding</h2>
        ${items.map((item, idx) => `
          <div class="quiz-item" data-item-id="${item.id}">
            <p>${idx + 1}. ${item.prompt}</p>
            ${item.options.map(opt => `
              <label class="quiz-option">
                <input type="radio" name="q-${item.id}" value="${opt.id}">
                ${opt.text}
              </label>
            `).join('')}
          </div>
        `).join('')}
        <button class="btn" id="submit-quiz-btn" disabled>Submit Quiz</button>
      </section>
    `;
  }

  main.innerHTML = '';
  main.appendChild(contentDiv);
  if(quizHTML){
    main.innerHTML += quizHTML;
    setupQuizListeners();
  }
}

//======================
// QUIZ LOGIC
//======================
function setupQuizListeners(){
  const btn = document.getElementById('submit-quiz-btn');
  const answers = {};
  const items = CHAPTER_CONFIG.assessmentItems;

  items.forEach(item => {
    document.querySelectorAll(`input[name="q-${item.id}"]`).forEach(input => {
      input.addEventListener('change', (e) => {
        answers[item.id] = e.target.value;
        btn.disabled = Object.keys(answers).length !== items.length;
      });
    });
  });

  if(btn){
    btn.addEventListener('click', () => showFeedback(answers));
  }
}

//======================
// FEEDBACK & SCORE
//======================
function showFeedback(answers){
  let correct = 0;
  const items = CHAPTER_CONFIG.assessmentItems;
  const feedback = items.map(item => {
    const selected = answers[item.id];
    const isCorrect = item.options.some(o => o.id === selected && o.is_correct);
    if(isCorrect) correct++;
    const correctOpt = item.options.find(o => o.is_correct);
    return {
      item,
      isCorrect,
      selected,
      correctText: correctOpt ? correctOpt.text : ' ‚Äî '
    };
  });

  const score = correct / items.length;
  const scorePercent = Math.round(score * 100);

  const feedbackHTML = feedback.map(f => `
    <div class="quiz-item">
      <p>${items.indexOf(f.item) + 1}. ${f.item.prompt}</p>
      ${f.item.options.map(opt => `
        <label class="quiz-option">
          <input type="radio" disabled ${opt.id === f.selected ? 'checked' : ''}>
          ${opt.text}${opt.is_correct ? '<strong>(Correct)</strong>' : ''}
        </label>
      `).join('')}
      <div class="quiz-feedback ${f.isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">
        ${f.isCorrect ? '‚úÖ Correct!' : `‚ùå Incorrect. Correct answer: ${f.correctText}`}
      </div>
    </div>
  `).join('');

  const scoreHTML = `
    <div class="score-card">
      <p><strong>Your Score:</strong> ${scorePercent}%</p>
    </div>
  `;

  const contentDiv = document.createElement('div');
  contentDiv.className = 'chapter-content';
  contentDiv.innerHTML = CHAPTER_CONFIG.content;

  main.innerHTML = '';
  main.appendChild(contentDiv);
  main.innerHTML += `
    <section class="card quiz-section">
      <h2>Check Your Understanding</h2>
      ${feedbackHTML}
      ${scoreHTML}
    </section>
  `;

  if(CHAPTER_CONFIG.whatsappNumber){
    const msg = encodeURIComponent(
      `My quiz score: ${scorePercent}%\nChapter: ${CHAPTER_CONFIG.title}\nStudent: [Your Name]`
    );
    const url = `https://wa.me/${CHAPTER_CONFIG.whatsappNumber}?text=${msg}`;
    const whatsappBtn = `
      <div style="text-align: center; margin-top: 1.5rem;">
        <a href="${url}" class="btn" style="background:#25D366; display: inline-flex; align-items: center; gap: 8px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="white">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.67.472-.173.941-.71 1.164-.91.941-.199-.223-1.758-1.755-2.784-1.755-.955 0-1.371.874-1.371 1.371 0 .497.874 1.29 1.371.497.298-.149.52.149.223.297 2.156 3.218 4.4 4.356.596.298 1.068.472 1.415.596.596.199 1.142.174 1.564.124.472-.05 1.37-.596 1.569-1.165.199-.575.199-1.068.149-1.167-.05-.099-.174-.149-.298-.149l-.91-.075c-.149-.05-.323-.05-.447 0z"/>
            <path d="M12 2c-5.523 0-10 4.477-10 10s4.477 10 10 10 10-4.477 10-10-4.477-10-10-10zm0 18c-4.418 0-8-3.582-8-8s3.582-8 8-8 8 3.582 8 8-3.582 8-8 8z"/>
          </svg> Send Score to Instructor
        </a>
        <p style="margin-top: 0.5rem; font-size: 0.9rem; color:#64748b;">Tap to share your results via WhatsApp</p>
      </div>
    `;
    main.innerHTML += whatsappBtn;
  }
}

//======================
// INITIALIZE
//======================
document.addEventListener('DOMContentLoaded', renderChapter);
})();
</script>
</body>
</html>
