<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Mini OpenStax: Clinical decision support for back pain triage (Ghana MoH Guidelines)" />
  <title>Mini OpenStax ‚Äî Back Pain Triage</title>
  <link rel="stylesheet" href="../css/main.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1 id="chapter-title">Loading Chapter...</h1>
        <div class="lo-tags" id="lo-tags"></div>
      </div>
      <div class="role-badge">Student View</div>
    </div>

    <main id="main-content">
      <div class="loading">Loading chapter content...</div>
    </main>
  </div>

  <!-- WhatsApp Support Button -->
<div style="text-align: center; margin: 2rem 0; padding: 1rem; background: #f0f9ff; border-radius: 8px; border: 1px solid #bae6fd;">
  <p style="margin: 0 0 1rem 0; color: #1e40af; font-weight: 600;">
    üí¨ Need more educational resources?
  </p>
  <a 
    href="https://wa.me/+233257320201?text=Hi!%20I%20need%20more%20educational%20resources%20from%20Mini%20OpenStax." 
    class="btn"
    style="background: #25d366; display: inline-flex; align-items: center; gap: 8px;"
    target="_blank"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="white">
      <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.67.472-.173.941-.71 1.164-.91.941-.199-.223-1.758-1.755-2.784-1.755-.955 0-1.371.874-1.371 1.371 0 .497.874 1.371 1.29 1.371.497 0 .298-.149.52.149.223.297 2.156 3.218 4.4 4.356.596.298 1.068.472 1.415.596.596.199 1.142.174 1.564.124.472-.05 1.37-.596 1.569-1.165.199-.575.199-1.068.149-1.167-.05-.099-.174-.149-.298-.149l-.91-.075c-.149-.05-.323-.05-.447 0z" />
      <path d="M12 2c-5.523 0-10 4.477-10 10s4.477 10 10 10 10-4.477 10-10-4.477-10-10-10zm0 18c-4.418 0-8-3.582-8-8s3.582-8 8-8 8 3.582 8 8-3.582 8-8 8z" />
    </svg>
    Chat on WhatsApp
  </a>
  <p style="margin-top: 0.75rem; font-size: 0.9rem; color: #475569;">
    Ask about additional resources, practice questions, or tutoring
  </p>
</div>

  <!-- Load classic app.js (no modules) -->
  <script src="../js/app.js"></script>
  <script>
    (function() {
      'use strict';

      const main = document.getElementById('main-content');
      const titleEl = document.getElementById('chapter-title');
      const loTagsEl = document.getElementById('lo-tags');

      // ======================
      // LOAD & RENDER CHAPTER
      // ======================
      function renderChapter() {
        titleEl.textContent = "Back Pain Triage";

        // LO Tags
        loTagsEl.innerHTML = '';
        const tags = ["MOH-BP-1", "EMERGENCY-TRIAGE", "CLINICAL-DECISION"];
        tags.forEach(tag => {
          const span = document.createElement('span');
          span.className = 'lo-tag';
          span.textContent = tag;
          loTagsEl.appendChild(span);
        });

        // Chapter Content (from back pain.pdf)
        const contentHTML = `
          <h2>When to Give Urgent Attention</h2>
          <p>Refer immediately if back pain is accompanied by <strong>any</strong> of the following:</p>
          <ul>
            <li>Bladder or bowel disturbance (retention or incontinence)</li>
            <li>Numbness of buttocks, perineum, or legs</li>
            <li>Leg weakness or difficulty walking</li>
            <li>Recent injury with abnormal or unavailable x-ray</li>
            <li>Sudden severe upper abdominal pain + nausea/vomiting ‚Üí <strong>pancreatitis</strong></li>
            <li>Pulsatile abdominal mass ‚Üí <strong>abdominal aortic aneurysm</strong></li>
            <li>Known cancer history</li>
          </ul>

          <h2>Flank Pain Algorithm</h2>
          <p>If flank pain is present, check urine dipstick:</p>
          <ul>
            <li><strong>Leucocytes/nitrites + fever + any of:</strong> vomiting, BP &lt; 90/60, pulse ‚â• 100, diabetes, male, pregnant/post-menopause ‚Üí <strong>complicated pyelonephritis</strong></li>
            <li><strong>Blood + sudden, severe, one-sided pain radiating to groin</strong> ‚Üí <strong>kidney stone</strong></li>
          </ul>

          <h2>Management of Urgent Conditions</h2>
          <table border="1" cellpadding="8" style="border-collapse: collapse; width: 100%; margin: 1.5rem 0;">
            <thead>
              <tr><th>Condition</th><th>Immediate Action</th></tr>
            </thead>
            <tbody>
              <tr><td>Abdominal aortic aneurysm</td><td>Avoid IV fluids even if BP &lt; 90/60</td></tr>
              <tr><td>Pancreatitis or shock (BP &lt; 90/60)</td><td>Give NaCl 0.9% 500mL IV over 30 min; repeat until SBP &gt; 90</td></tr>
              <tr><td>Complicated pyelonephritis</td><td>Collect urine for MCS, then give ceftriaxone 1g IV/IM</td></tr>
              <tr><td>Kidney stone</td><td>Give NaCl 0.9% 1L IV 6-hourly; morphine 10mg IM if severe pain</td></tr>
              <tr><td>Known cancer</td><td>Refer same day</td></tr>
            </tbody>
          </table>

          <h2>Non-Urgent Back Pain</h2>
          <p>If no red flags, consider:</p>
          <ul>
            <li><strong>Uncomplicated pyelonephritis:</strong> ciprofloxacin 500mg 12-hourly √ó 7 days + paracetamol</li>
            <li><strong>Mechanical back pain:</strong> reassure, encourage activity, paracetamol first-line</li>
            <li><strong>Inflammatory back pain:</strong> check ESR, test for HIV/TB, refer</li>
          </ul>

          <h2>Pain Relief Ladder (Mechanical Back Pain)</h2>
          <ol>
            <li>Paracetamol 1g 4‚Äì6 hourly (max 4g/24h) √ó 5 days</li>
            <li>Add ibuprofen 400mg 8-hourly with food √ó 5 days (if no contraindications)</li>
            <li>Add tramadol 50mg 6-hourly √ó 5 days if still uncontrolled</li>
          </ol>
        `;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'chapter-content';
        contentDiv.innerHTML = contentHTML;

        // Quiz Section
        const quizHTML = `
          <section class="card quiz-section">
            <h2>Clinical Knowledge Check</h2>
            ${assessmentItems.map((item, idx) => `
              <div class="quiz-item" data-item-id="${item.id}">
                <p>${idx + 1}. ${sanitizeHTML(item.prompt)}</p>
                ${item.options.map(opt => `
                  <label class="quiz-option">
                    <input type="radio" name="q-${item.id}" value="${opt.id}">
                    ${sanitizeHTML(opt.text)}
                  </label>
                `).join('')}
              </div>
            `).join('')}
            <button class="btn" id="submit-quiz-btn" disabled>Submit Quiz</button>
          </section>
        `;

        main.innerHTML = '';
        main.appendChild(contentDiv);
        main.innerHTML += quizHTML;
        setupQuizListeners();
      }

      // ======================
      // SANITIZE HTML
      // ======================
      function sanitizeHTML(str) {
        if (typeof str !== 'string') return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      // ======================
      // 20 MCQs FROM BACK PAIN GUIDELINE
      // ======================
      const assessmentItems = [
        {
          id: "1",
          prompt: "Which symptom requires URGENT referral in a client with back pain?",
          options: [
            { id: "a", text: "Pain worse at night", is_correct: false },
            { id: "b", text: "Bladder incontinence", is_correct: true },
            { id: "c", text: "Pain after lifting", is_correct: false },
            { id: "d", text: "Mild fever", is_correct: false }
          ]
        },
        {
          id: "2",
          prompt: "A pulsatile abdominal mass with back pain suggests:",
          options: [
            { id: "a", text: "Pancreatitis", is_correct: false },
            { id: "b", text: "Kidney stone", is_correct: false },
            { id: "c", text: "Abdominal aortic aneurysm", is_correct: true },
            { id: "d", text: "Pyelonephritis", is_correct: false }
          ]
        },
        {
          id: "3",
          prompt: "What is the FIRST action for suspected abdominal aortic aneurysm?",
          options: [
            { id: "a", text: "Give IV fluids", is_correct: false },
            { id: "b", text: "Give morphine", is_correct: false },
            { id: "c", text: "Avoid IV fluids", is_correct: true },
            { id: "d", text: "Give ciprofloxacin", is_correct: false }
          ]
        },
        {
          id: "4",
          prompt: "For BP < 90/60 with back pain, give:",
          options: [
            { id: "a", text: "Ceftriaxone 1g IV", is_correct: false },
            { id: "b", text: "NaCl 0.9% 500mL IV over 30 min", is_correct: true },
            { id: "c", text: "Morphine 10mg IM", is_correct: false },
            { id: "d", text: "Tramadol 50mg", is_correct: false }
          ]
        },
        {
          id: "5",
          prompt: "Complicated pyelonephritis is likely if urine shows leucocytes AND:",
          options: [
            { id: "a", text: "Client is female", is_correct: false },
            { id: "b", text: "BP < 90/60 or pulse ‚â• 100", is_correct: true },
            { id: "c", text: "Pain for 2 days", is_correct: false },
            { id: "d", text: "No fever", is_correct: false }
          ]
        },
        {
          id: "6",
          prompt: "First-line drug for uncomplicated pyelonephritis is:",
          options: [
            { id: "a", text: "Ceftriaxone", is_correct: false },
            { id: "b", text: "Ciprofloxacin", is_correct: true },
            { id: "c", text: "Tramadol", is_correct: false },
            { id: "d", text: "Ibuprofen", is_correct: false }
          ]
        },
        {
          id: "7",
          prompt: "Kidney stone pain is typically:",
          options: [
            { id: "a", text: "Dull and aching", is_correct: false },
            { id: "b", text: "Sudden, severe, one-sided, radiating to groin", is_correct: true },
            { id: "c", text: "Worse with rest", is_correct: false },
            { id: "d", text: "Associated with bowel incontinence", is_correct: false }
          ]
        },
        {
          id: "8",
          prompt: "First-line pain relief for mechanical back pain is:",
          options: [
            { id: "a", text: "Ibuprofen", is_correct: false },
            { id: "b", text: "Tramadol", is_correct: false },
            { id: "c", text: "Paracetamol", is_correct: true },
            { id: "d", text: "Morphine", is_correct: false }
          ]
        },
        {
          id: "9",
          prompt: "A client with known cancer and new back pain should be:",
          options: [
            { id: "a", text: "Given paracetamol and reviewed in 1 week", is_correct: false },
            { id: "b", text: "Referred same day", is_correct: true },
            { id: "c", text: "Treated as mechanical back pain", is_correct: false },
            { id: "d", text: "Given ciprofloxacin", is_correct: false }
          ]
        },
        {
          id: "10",
          prompt: "Ibuprofen should be AVOIDED in clients with:",
          options: [
            { id: "a", text: "All of the above", is_correct: true },
            { id: "b", text: "Peptic ulcer", is_correct: false },
            { id: "c", text: "Asthma", is_correct: false },
            { id: "d", text: "Hypertension", is_correct: false }
          ]
        },
        {
          id: "11",
          prompt: "If back pain persists ‚â• 4 weeks, you should:",
          options: [
            { id: "a", text: "Continue analgesics", is_correct: false },
            { id: "b", text: "Reassure and wait", is_correct: false },
            { id: "c", text: "Assess and refer to doctor", is_correct: true },
            { id: "d", text: "Start tramadol", is_correct: false }
          ]
        },
        {
          id: "12",
          prompt: "Inflammatory back pain is suggested by:",
          options: [
            { id: "a", text: "Pain worse with exercise", is_correct: false },
            { id: "b", text: "Sleep disturbed by pain", is_correct: true },
            { id: "c", text: "Pain improves with rest", is_correct: false },
            { id: "d", text: "Age > 50", is_correct: false }
          ]
        },
        {
          id: "13",
          prompt: "For kidney stone with severe pain, give:",
          options: [
            { id: "a", text: "Ciprofloxacin", is_correct: false },
            { id: "b", text: "Morphine 10mg IM", is_correct: true },
            { id: "c", text: "Ceftriaxone", is_correct: false },
            { id: "d", text: "Tramadol only", is_correct: false }
          ]
        },
        {
          id: "14",
          prompt: "Uncomplicated pyelonephritis requires referral if no improvement after:",
          options: [
            { id: "a", text: "12 hours", is_correct: false },
            { id: "b", text: "2 days", is_correct: true },
            { id: "c", text: "1 week", is_correct: false },
            { id: "d", text: "2 weeks", is_correct: false }
          ]
        },
        {
          id: "15",
          prompt: "Mechanical back pain advice includes:",
          options: [
            { id: "a", text: "Bed rest for 1 week", is_correct: false },
            { id: "b", text: "Avoid all activity", is_correct: false },
            { id: "c", text: "Continue normal activity", is_correct: true },
            { id: "d", text: "Apply ice only", is_correct: false }
          ]
        },
        {
          id: "16",
          prompt: "If flank pain + blood on dipstick + severe pain ‚Üí think:",
          options: [
            { id: "a", text: "Pyelonephritis", is_correct: false },
            { id: "b", text: "Kidney stone", is_correct: true },
            { id: "c", text: "Pancreatitis", is_correct: false },
            { id: "d", text: "AAA", is_correct: false }
          ]
        },
        {
          id: "17",
          prompt: "Which is a red flag for back pain?",
          options: [
            { id: "a", text: "Pain for 3 days", is_correct: false },
            { id: "b", text: "Leg weakness", is_correct: true },
            { id: "c", text: "Mild tenderness", is_correct: false },
            { id: "d", text: "Pain after gardening", is_correct: false }
          ]
        },
        {
          id: "18",
          prompt: "For inflammatory back pain, the doctor should:",
          options: [
            { id: "a", text: "Give paracetamol and discharge", is_correct: false },
            { id: "b", text: "Check ESR and test for HIV", is_correct: true },
            { id: "c", text: "Start ciprofloxacin", is_correct: false },
            { id: "d", text: "Advise bed rest", is_correct: false }
          ]
        },
        {
          id: "19",
          prompt: "Maximum paracetamol dose in 24 hours is:",
          options: [
            { id: "a", text: "2g", is_correct: false },
            { id: "b", text: "3g", is_correct: false },
            { id: "c", text: "4g", is_correct: true },
            { id: "d", text: "5g", is_correct: false }
          ]
        },
        {
          id: "20",
          prompt: "If BP drops < 90/60 during morphine administration, you should:",
          options: [
            { id: "a", text: "Give more morphine", is_correct: false },
            { id: "b", text: "Stop morphine", is_correct: true },
            { id: "c", text: "Give ibuprofen", is_correct: false },
            { id: "d", text: "Ignore it", is_correct: false }
          ]
        }
      ];

      // ======================
      // QUIZ LOGIC (SAME AS BEFORE)
      // ======================
      function setupQuizListeners() {
        const submitBtn = document.getElementById('submit-quiz-btn');
        const answers = {};

        assessmentItems.forEach(item => {
          const inputs = document.querySelectorAll(`input[name="q-${item.id}"]`);
          inputs.forEach(input => {
            input.addEventListener('change', (e) => {
              answers[item.id] = e.target.value;
              updateSubmitButton(submitBtn, Object.keys(answers).length, assessmentItems.length);
            });
          });
        });

        if (submitBtn) {
          submitBtn.addEventListener('click', () => {
            showFeedback(answers);
          });
        }
      }

      function updateSubmitButton(button, answered, total) {
        if (button) {
          button.disabled = answered !== total;
        }
      }

      function showFeedback(answers) {
        let correctCount = 0;
        const total = assessmentItems.length;

        const feedbackHTML = assessmentItems.map(item => {
          const selectedId = answers[item.id];
          const selectedOpt = item.options.find(opt => opt.id === selectedId);
          const correctOpt = item.options.find(opt => opt.is_correct);
          const isCorrect = selectedOpt?.is_correct || false;

          if (isCorrect) correctCount++;

          return `
            <div class="quiz-item" data-item-id="${item.id}">
              <p>${assessmentItems.indexOf(item) + 1}. ${sanitizeHTML(item.prompt)}</p>
              ${item.options.map(opt => `
                <label class="quiz-option">
                  <input type="radio" name="q-${item.id}" value="${opt.id}" disabled
                    ${opt.id === selectedId ? 'checked' : ''}>
                  ${sanitizeHTML(opt.text)}
                  ${opt.is_correct ? ' <strong>(Correct)</strong>' : ''}
                </label>
              `).join('')}
              <div class="quiz-feedback ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">
                ${isCorrect ? '‚úÖ Correct!' : `‚ùå Incorrect. Correct answer: ${sanitizeHTML(correctOpt?.text || '‚Äî')}`}
              </div>
            </div>
          `;
        }).join('');

        const score = correctCount / total;
        const scoreHTML = `
          <div class="score-card">
            <p><strong>Your Score:</strong> ${Math.round(score * 100)}%</p>
          </div>
        `;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'chapter-content';
        // Re-render content without quiz
        contentDiv.innerHTML = `
          <h2>When to Give Urgent Attention</h2>
          <p>Refer immediately if back pain is accompanied by <strong>any</strong> of the following: ... </p>
          <!-- abbreviated for brevity in re-render -->
        `;

        main.innerHTML = '';
        main.appendChild(contentDiv);
        main.innerHTML += `
          <section class="card quiz-section">
            <h2>Clinical Knowledge Check</h2>
            ${feedbackHTML}
            ${scoreHTML}
          </section>
        `;
      }

      // ======================
      // INITIALIZE
      // ======================
      document.addEventListener('DOMContentLoaded', renderChapter);
    })();
  </script>
</body>
</html>
