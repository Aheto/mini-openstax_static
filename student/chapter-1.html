

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Mini OpenStax: Student chapter view with auto-graded quiz (static)" />
  <title>Mini OpenStax — Linear Equations</title>
  <link rel="stylesheet" href="../css/main.css">

<!-- If you load app.js -->
<script src="../js/app.js"></script>
  
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1 id="chapter-title">Loading Chapter...</h1>
        <div class="lo-tags" id="lo-tags"></div>
      </div>
      <div class="role-badge">Student View</div>
    </div>

    <main id="main-content">
      <div class="loading">Loading chapter content...</div>
    </main>
  </div>

  <script type="module">
    (function() {
      // ======================
      // LOAD CHAPTER DATA
      // ======================
      async function loadChapter() {
        try {
          const res = await fetch('../data/chapters/chapter-1.json');
          if (!res.ok) throw new Error('Chapter data not found');
          const chapter = await res.json();
          renderChapter(chapter);
        } catch (err) {
          document.getElementById('main-content').innerHTML = 
            `<div class="error">Failed to load chapter: ${err.message}</div>`;
        }
      }

      // ======================
      // SANITIZE HTML (BASIC)
      // ======================
      function sanitizeHTML(str) {
        if (typeof str !== 'string') return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      // ======================
      // RENDER CHAPTER
      // ======================
      function renderChapter(chapter) {
        const main = document.getElementById('main-content');
        const title = document.getElementById('chapter-title');
        const loTags = document.getElementById('lo-tags');

        // Title
        title.textContent = sanitizeHTML(chapter.title);

        // LO Tags
        loTags.innerHTML = '';
        chapter.learning_objectives.forEach(lo => {
          const tag = document.createElement('span');
          tag.className = 'lo-tag';
          tag.textContent = sanitizeHTML(lo.tag);
          loTags.appendChild(tag);
        });

        // Chapter Content
        const contentDiv = document.createElement('div');
        contentDiv.className = 'chapter-content';
        contentDiv.innerHTML = chapter.content_html;

        // Quiz Section
        let quizHTML = '';
        if (chapter.assessment_items && chapter.assessment_items.length > 0) {
          quizHTML = `
            <section class="card quiz-section">
              <h2>Check Your Understanding</h2>
              ${chapter.assessment_items.map(item => `
                <div class="quiz-item" data-item-id="${item.id}">
                  <p>${sanitizeHTML(item.prompt)}</p>
                  ${item.options.map(opt => `
                    <label class="quiz-option">
                      <input type="radio" name="q-${item.id}" value="${opt.id}">
                      ${sanitizeHTML(opt.text)}
                    </label>
                  `).join('')}
                </div>
              `).join('')}
              <button class="btn" id="submit-quiz-btn" disabled>Submit Quiz</button>
            </section>
          `;
        }

        // Render
        main.innerHTML = '';
        main.appendChild(contentDiv);
        if (quizHTML) {
          main.innerHTML += quizHTML;
          setupQuizListeners(chapter);
        }
      }

      // ======================
      // QUIZ LOGIC (STATIC)
      // ======================
      function setupQuizListeners(chapter) {
        const submitBtn = document.getElementById('submit-quiz-btn');
        const answers = {};

        // Track selections
        chapter.assessment_items.forEach(item => {
          const inputs = document.querySelectorAll(`input[name="q-${item.id}"]`);
          inputs.forEach(input => {
            input.addEventListener('change', (e) => {
              answers[item.id] = e.target.value;
              updateSubmitButton(submitBtn, answers, chapter.assessment_items.length);
            });
          });
        });

        // Handle submission
        if (submitBtn) {
          submitBtn.addEventListener('click', () => {
            showFeedback(chapter, answers);
          });
        }
      }

      function updateSubmitButton(button, answers, totalItems) {
        if (button) {
          button.disabled = Object.keys(answers).length !== totalItems;
        }
      }

      function showFeedback(chapter, answers) {
        const main = document.getElementById('main-content');

        // Calculate score & feedback
        let correctCount = 0;
        const total = chapter.assessment_items.length;

        const feedbackHTML = chapter.assessment_items.map(item => {
          const selectedOptionId = answers[item.id];
          const selectedOption = item.options.find(opt => opt.id === selectedOptionId);
          const correctOption = item.options.find(opt => opt.is_correct);
          const isCorrect = selectedOption?.is_correct || false;

          if (isCorrect) correctCount++;

          return `
            <div class="quiz-item" data-item-id="${item.id}">
              <p>${sanitizeHTML(item.prompt)}</p>
              ${item.options.map(opt => `
                <label class="quiz-option">
                  <input type="radio" name="q-${item.id}" value="${opt.id}" disabled
                    ${opt.id === selectedOptionId ? 'checked' : ''}>
                  ${sanitizeHTML(opt.text)}
                  ${opt.is_correct ? ' <strong>(Correct)</strong>' : ''}
                </label>
              `).join('')}
              <div class="quiz-feedback ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">
                ${isCorrect ? '✅ Correct!' : `❌ Incorrect. The correct answer is: ${sanitizeHTML(correctOption?.text || '—')}`}
              </div>
            </div>
          `;
        }).join('');

        const score = correctCount / total;
        const scoreHTML = `
          <div class="score-card">
            <p><strong>Your Score:</strong> ${Math.round(score * 100)}%</p>
            <button class="btn btn-secondary" disabled>Quiz Submitted</button>
          </div>
        `;

        // Re-render with feedback
        const title = document.getElementById('chapter-title');
        const loTags = document.getElementById('lo-tags');

        main.innerHTML = `
          <div class="chapter-content">${chapter.content_html}</div>
          <section class="card quiz-section">
            <h2>Check Your Understanding</h2>
            ${feedbackHTML}
            ${scoreHTML}
          </section>
        `;

        // Restore header
        document.querySelector('.header h1').textContent = title.textContent;
        document.querySelector('.header .lo-tags').innerHTML = loTags.innerHTML;
      }

      // ======================
      // INITIALIZE
      // ======================
      document.addEventListener('DOMContentLoaded', loadChapter);
    })();
  </script>
</body>
</html>
